# AstraCRM Widget — Full Integration Guide (EN)

[Русская версия](./INTEGRRATION_RU.md)

Official integration guide for embedding the AstraCRM order widget into any website. No source reading required — just paste the snippet and configure attributes.

- Component: custom element `astra-order-widget`
- Modes: Floating (button), Embedded (block), Headless (no UI)
- Distribution: single UMD bundle, optional headless-only bundle
- CDN: `https://cdn.astracrm.pro/widget/v1/astra-widget.umd.js`
- Requirements: modern browser, HTTPS, public widget key

---

## Quick Start (TL;DR)

### A) Using `api-key` attribute

```html
<script src="https://cdn.astracrm.pro/widget/v1/astra-widget.umd.js"></script>

<astra-order-widget
  api-key="YOUR_PUBLIC_KEY"
  mode="floating"
  position="bottom-right"
  button-text="Request service">
</astra-order-widget>
```

### B) Using global variable (often generated by CRM UI)

```html
<script>
  window.ASTRA_WIDGET_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
  // Optional: custom API base URL
  // window.ASTRA_WIDGET_API_BASE_URL = 'https://api.astracrm.com';
</script>
<script src="https://cdn.astracrm.pro/widget/v1/astra-widget.umd.js"></script>

<astra-order-widget mode="floating" position="bottom-right"></astra-order-widget>
```

Done. The widget registers `customElements.define('astra-order-widget', ...)` and renders itself.

---

## Modes

### 1) Floating (button)
- A floating button opens the form on click.
- Positions: `bottom-right` (default), `bottom-left`, `top-right`, `top-left`, `bottom-center`, `right-center`, `left-center`.
- Customize with `button-text` and `button-icon`.

Example:
```html
<astra-order-widget
  api-key="..."
  mode="floating"
  position="bottom-center"
  button-text="Need help?"
  button-icon="message">
</astra-order-widget>
```

Supported `button-icon`: `message` (default), `users`, `star`, `clock`.

### 2) Embedded (block)
- Renders as a normal block at the insertion point; fits container width.
- Optional title/subtitle.

```html
<section class="contact">
  <h2>Service request</h2>
  <astra-order-widget
    api-key="..."
    mode="embedded"
    theme="light"
    widget-title="Request a service"
    widget-subtitle="Describe your issue — we'll call you back">
  </astra-order-widget>
</section>
```

### 3) Headless (no UI)
- Business logic/validation/network are handled inside; you control the UI.
- Enable with `mode="headless"`. Access API as `__ASTRA_WIDGET_API__` on the element after `widget:ready`.
- Optional headless-only bundle: `astra-widget.headless.umd.js`.

Minimal example:
```html
<script src="https://cdn.astracrm.pro/widget/v1/astra-widget.umd.js"></script>
<astra-order-widget mode="headless" api-key="..."></astra-order-widget>
<script>
  const el = document.querySelector('astra-order-widget');
  el.addEventListener('widget:ready', async () => {
    const api = el.__ASTRA_WIDGET_API__;
    api.setFormData({ clientPhone: '+15550001122', description: 'Need technician' });
    if (api.isValid()) {
      const res = await api.submit();
      console.log('Order created:', res.orderId);
      if (res.redirectUrl) window.location.href = res.redirectUrl;
    }
  }, { once: true });
<\/script>
```

See `docs/HEADLESS_INTEGRATION.md` for advanced headless patterns.

---

## Attributes

| Attribute | Type/values | Default | Purpose |
|---|---|---|---|
| `api-key` | string | — | Public widget key (or use `window.ASTRA_WIDGET_PUBLIC_KEY`). |
| `api-url` | URL | dev: `http://localhost:8000`, otherwise from `window.ASTRA_WIDGET_API_BASE_URL` | Public API base URL. |
| `mode` | `floating` · `embedded` · `headless` | `floating` | Display mode. |
| `theme` | `light` · `dark` | `light` | Color theme. |
| `locale` | `en` · `ru` | `en` | UI language. |
| `required-fields` | CSV (`clientPhone,description,...`) | `clientPhone,description` | Required fields. |
| `show-service-selector` | `true` · `false` | `false` | Show service/subservice selector (if available). |
| `position` | see list | `bottom-right` | Floating button position. |
| `button-text` | string | auto by `locale` | Floating button text. |
| `button-icon` | `message` · `users` · `star` · `clock` | `message` | Floating button icon. |
| `widget-title` | string | auto | Form title (embedded/floating welcome screen). |
| `widget-subtitle` | string | auto | Form subtitle. |
| `order-state` | `draft` · `distributing` | `draft` | Initial order state for public submission. |
| `debug` | `true` · `false` | `false` | Verbose event logs + DOM events. |
| `success-redirect` | URL | — | Not used automatically; read manually if needed. |

Priority: element attributes > `window.*` globals.

---

## Global variables (optional)

- `window.ASTRA_WIDGET_PUBLIC_KEY` — public key
- `window.ASTRA_WIDGET_API_BASE_URL` — public API base URL

Typically generated by AstraCRM UI (Widgets → Embed → Code).

```html
<script>
  window.ASTRA_WIDGET_PUBLIC_KEY = 'pk_live_xxxxx';
  window.ASTRA_WIDGET_API_BASE_URL = 'https://api.astracrm.com';
</script>
<script src="https://cdn.astracrm.pro/widget/v1/astra-widget.umd.js"></script>
```

---

## Networking & security

- Public key is not a secret.
- Always use **HTTPS** and correct **CORS**.
- CSP recommended.

Public endpoints:
- `GET /public/widget-config`
- `POST /public/orders/add`
- `POST /public/suggest/address`

---

## Localization

- `locale="en" | "ru"`
- Titles can be overridden with `widget-title` / `widget-subtitle`.

---

## Theming

`theme="light|dark"`. CSS custom properties:

```css
astra-order-widget {
  --ow-primary: #3b82f6;
  --ow-secondary: #64748b;
  --ow-background: #ffffff;
  --ow-text: #1f2937;
  --ow-border: #e5e7eb;
  --ow-border-radius: 12px;
  --ow-shadow-floating: 0 25px 50px -12px rgba(0,0,0,.25);
}
```

---

## Form & validation

Submission data:
- `clientPhone`: required; `^((+?7)|8)?\d{10}$`
- `description`: required; 1..1000
- `serviceId`: required; uuid-like
- `subServiceId`: optional; uuid-like
- `categoryOnly`: optional
- `address`: optional; ≤500
- `addressSuggestion`: optional; structured (DaData)

`required-fields` lets you adjust required fields on the client.

---

## Submission & result

States: `validating → submitting → processing → success|error`.
Success response has `orderId` and may include `redirectUrl` (if configured).
No auto-redirect on `success-redirect` — read `redirectUrl` or use events/headless.

---

## DOM events

Dispatched on the `astra-order-widget` element:
- `widget:init`, `widget:ready`, `widget:destroy`
- `widget:form-change`, `widget:validation-change`
- `widget:submit-start`, `widget:submit-success`, `widget:submit-error`
- `widget:state-change`, `widget:step-change`, `widget:error`

```js
const el = document.querySelector('astra-order-widget');
el.addEventListener('widget:submit-success', (e) => {
  console.log('Order created:', e.detail.orderId);
});
```

---

## Headless API (quick ref)

Available as `el.__ASTRA_WIDGET_API__` after `widget:ready`.

Core methods:
- Config: `getConfig()`, `updateConfig(partial)`
- Form: `getFormData()`, `setFormData(partial)`, `clearFormData()`
- Validation: `validate(field?)`, `isValid()`
- State: `getState()`, `getCurrentStep()`, `goToStep(step)`
- Submit: `submit() → { orderId, redirectUrl? }`, `reset()`
- Services: `loadServices()`, `selectService(categoryId, subcategoryId?)`, `getSelectedService()`
- Events: `on`, `off`, `emit`
- Lifecycle: `destroy()`

See `docs/HEADLESS_INTEGRATION.md` for details.

---

## FAQ

- “Missing widget public key” — add `api-key` or set `window.ASTRA_WIDGET_PUBLIC_KEY`.
- “Missing widget API base URL” — set `window.ASTRA_WIDGET_API_BASE_URL`.
- Embedded not visible — check container width/styles.
- Button icon off — use supported: `message`, `users`, `star`, `clock`.
- CORS — ensure your origin is allowed and use HTTPS.

---

## Browser support

- Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- Mobile: iOS Safari 14+, Chrome Mobile 90+

---

## Snippets

From AstraCRM UI (Widgets → Embed → Code):

```html
<script>
  window.ASTRA_WIDGET_PUBLIC_KEY = 'pk_live_xxxxx';
  window.ASTRA_WIDGET_API_BASE_URL = 'https://api.astracrm.com';
</script>
<script src="https://cdn.astracrm.pro/widget/v1/astra-widget.umd.js"></script>

<!-- Floating -->
<astra-order-widget mode="floating" position="bottom-right" button-text="Request service"></astra-order-widget>

<!-- Embedded -->
<astra-order-widget mode="embedded" theme="light" widget-title="Request service" widget-subtitle="We will contact you shortly"></astra-order-widget>
```

Headless-only:

```html
<script src="https://cdn.astracrm.pro/widget/v1/astra-widget.headless.umd.js"></script>
<astra-order-widget mode="headless" api-key="..."></astra-order-widget>
```

---

## Contacts

- Integration questions: support@astracrm.pro
- Feedback: open an issue in the public docs repository


